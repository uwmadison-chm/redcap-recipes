// ============================================================================
// Survey Timing Builder - Vanilla JS Module
// ============================================================================

// ============================================================================
// STATE
// ============================================================================

const state = {
  parsedProject: null,
  surveys: [],           // Array of {name, label, selected}
  formName: "survey_timing"
};

// ============================================================================
// XML PARSING
// ============================================================================

function parseRedcapXml(xmlText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, "text/xml");

  const studyName = doc.querySelector("StudyName")?.textContent || "Unknown Project";

  // Get all forms with their labels
  const formLabels = new Map();
  doc.querySelectorAll("FormDef").forEach(form => {
    const name = form.getAttribute("redcap:FormName") || form.getAttribute("Name");
    const label = form.getAttribute("Name");
    formLabels.set(name, label);
  });

  const forms = Array.from(formLabels.entries()).map(([name, label]) => ({ name, label }));

  // Get survey-enabled forms from redcap:SurveysGroup > redcap:Surveys
  const surveyForms = new Map(); // form_name -> title

  doc.querySelectorAll("redcap\\:Surveys, Surveys").forEach(survey => {
    const formName = survey.getAttribute("form_name");
    const surveyEnabled = survey.getAttribute("survey_enabled");
    const title = survey.getAttribute("title");

    if (formName && surveyEnabled === "1") {
      surveyForms.set(formName, title || formLabels.get(formName) || formName);
    }
  });

  // Build surveys array - if we found specific survey info, use it; otherwise include all forms
  let surveys;
  if (surveyForms.size > 0) {
    surveys = Array.from(surveyForms.entries()).map(([name, title]) => ({
      name,
      label: title,
      selected: true
    }));
  } else {
    // No survey info found - include all forms and let user select
    surveys = forms.map(f => ({ name: f.name, label: f.label, selected: true }));
  }

  return { projectName: studyName, forms, surveys };
}

// ============================================================================
// CSV GENERATION
// ============================================================================

function generateInstrumentRows() {
  const { surveys, formName } = state;
  const selectedSurveys = surveys.filter(s => s.selected);

  const headers = [
    "Variable / Field Name", "Form Name", "Section Header", "Field Type", "Field Label",
    "Choices, Calculations, OR Slider Labels", "Field Note", "Text Validation Type OR Show Slider Number",
    "Text Validation Min", "Text Validation Max", "Identifier?", "Branching Logic (Show field only if...)",
    "Required Field?", "Custom Alignment", "Question Number (surveys only)", "Matrix Group Name",
    "Matrix Ranking?", "Field Annotation"
  ];

  const rows = [headers];

  // Descriptive field at the top with warning
  const warningText = `<div class="rich-text-field-label"><p>This form was generated by the <a href="https://uwmadison-chm.github.io/redcap-recipes/recipes/survey_timing/builder/">Survey Timing Builder</a> in <a href="https://uwmadison-chm.github.io/redcap-recipes/">REDCap Recipes</a>.</p><p>Using the builder again will overwrite any manual changes to this form.</p></div>`;
  rows.push([
    `${formName}_info`,
    formName,
    "",
    "descriptive",
    warningText,
    "", "", "", "", "", "", "", "", "", "", "", "", ""
  ]);

  // Generate fields for each selected survey
  selectedSurveys.forEach((survey, idx) => {
    const sectionHeader = idx === 0 ? "Survey Timing Fields" : "";

    // Started at field
    rows.push([
      `${survey.name}_started_at`,
      formName,
      sectionHeader,
      "text",
      `${survey.label}: Started at`,
      "",
      "",
      "datetime_seconds_ymd",
      "", "", "", "", "", "", "", "", "",
      `@CALCTEXT([survey-time-started:${survey.name}:value])`
    ]);

    // Completed at field
    rows.push([
      `${survey.name}_completed_at`,
      formName,
      "",
      "text",
      `${survey.label}: Completed at`,
      "",
      "",
      "datetime_seconds_ymd",
      "", "", "", "", "", "", "", "", "",
      `@CALCTEXT([survey-time-completed:${survey.name}:value])`
    ]);

    // Duration field
    rows.push([
      `${survey.name}_duration`,
      formName,
      "",
      "text",
      `${survey.label}: Duration (seconds)`,
      "",
      "",
      "integer",
      "", "", "", "", "", "", "", "", "",
      `@CALCTEXT([survey-duration-completed:${survey.name}])`
    ]);
  });

  return rows;
}

function generateInstrumentCsv() {
  const rows = generateInstrumentRows();
  return rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\n");
}

// ============================================================================
// UI RENDERING
// ============================================================================

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function renderProjectInfo() {
  const container = document.getElementById("project-info");
  if (!container) return;

  if (state.parsedProject) {
    const surveyCount = state.surveys.length;
    const formCount = state.parsedProject.forms.length;

    let infoText = `<strong>Loaded:</strong> ${escapeHtml(state.parsedProject.projectName)}<br>`;
    infoText += `<small>${formCount} instruments`;
    if (surveyCount < formCount) {
      infoText += `, ${surveyCount} surveys detected`;
    }
    infoText += `</small>`;

    container.innerHTML = `
      <div class="callout callout-tip">
        ${infoText}
      </div>
    `;
  } else {
    container.innerHTML = "";
  }
}

function renderSurveySelection() {
  const container = document.getElementById("survey-selection");
  if (!container) return;

  if (state.surveys.length === 0) {
    container.innerHTML = `<p class="text-muted">Upload a project XML to see available surveys.</p>`;
    return;
  }

  const selectedCount = state.surveys.filter(s => s.selected).length;

  let html = `
    <div class="mb-2">
      <button class="btn btn-sm btn-outline-secondary me-2" id="select-all-btn">Select All</button>
      <button class="btn btn-sm btn-outline-secondary" id="select-none-btn">Select None</button>
      <span class="text-muted ms-3">${selectedCount} of ${state.surveys.length} selected</span>
    </div>
    <div class="row">
  `;

  state.surveys.forEach((survey, idx) => {
    const labelText = survey.label !== survey.name
      ? `${escapeHtml(survey.label)} (<code>${escapeHtml(survey.name)}</code>)`
      : `<code>${escapeHtml(survey.name)}</code>`;
    html += `
      <div class="col-md-6 col-lg-4">
        <div class="form-check">
          <input class="form-check-input survey-checkbox" type="checkbox"
            id="survey-${idx}" data-idx="${idx}" ${survey.selected ? 'checked' : ''}>
          <label class="form-check-label" for="survey-${idx}">${labelText}</label>
        </div>
      </div>
    `;
  });

  html += `</div>`;
  container.innerHTML = html;

  // Wire up checkboxes
  container.querySelectorAll(".survey-checkbox").forEach(checkbox => {
    checkbox.addEventListener("change", () => {
      const idx = parseInt(checkbox.dataset.idx);
      state.surveys[idx].selected = checkbox.checked;
      renderSurveySelection();
      renderDownloads();
    });
  });

  // Wire up select all/none buttons
  document.getElementById("select-all-btn")?.addEventListener("click", () => {
    state.surveys.forEach(s => s.selected = true);
    renderSurveySelection();
    renderDownloads();
  });

  document.getElementById("select-none-btn")?.addEventListener("click", () => {
    state.surveys.forEach(s => s.selected = false);
    renderSurveySelection();
    renderDownloads();
  });
}

function renderDownloads() {
  const section = document.getElementById("download-section");
  const container = document.getElementById("download-buttons");
  const previewContainer = document.getElementById("preview-container");

  if (!section || !container) return;

  const selectedCount = state.surveys.filter(s => s.selected).length;

  if (selectedCount === 0) {
    section.style.display = "none";
    return;
  }

  section.style.display = "block";

  container.innerHTML = "";

  const btn = document.createElement("button");
  btn.className = "btn btn-primary";
  btn.innerHTML = `<strong>Download Instrument ZIP</strong>`;
  btn.addEventListener("click", downloadInstrumentZip);
  container.appendChild(btn);

  // Preview as table showing field name and annotation
  const rows = generateInstrumentRows();
  const timingFieldCount = selectedCount * 3 + 1;

  if (previewContainer) {
    // Skip header row (index 0) and info field (index 1)
    const dataRows = rows.slice(2);

    let tableHtml = `
      <div style="position: relative;">
        <div style="text-align: right; font-size: 0.8em; color: var(--bs-secondary); margin-bottom: 0.5rem;">
          ${timingFieldCount} fields
        </div>
        <div style="max-height: 400px; overflow: auto;">
          <table class="table table-sm table-striped" style="font-size: 0.85em;">
            <thead>
              <tr>
                <th>Field Name</th>
                <th>Annotation</th>
              </tr>
            </thead>
            <tbody>
    `;

    dataRows.forEach(row => {
      const fieldName = row[0];
      const annotation = row[17];
      tableHtml += `
        <tr>
          <td><code>${escapeHtml(fieldName)}</code></td>
          <td><code>${escapeHtml(annotation)}</code></td>
        </tr>
      `;
    });

    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    previewContainer.innerHTML = tableHtml;
  }
}

// ============================================================================
// DOWNLOAD
// ============================================================================

function downloadInstrumentZip() {
  const { formName } = state;
  const csv = generateInstrumentCsv();

  const zip = new JSZip();
  zip.file("instrument.csv", csv);

  // REDCap instrument ZIPs include an OriginID.txt file
  const origin = `REDCap Recipes Survey Timing Builder\nhttps://uwmadison-chm.github.io/redcap-recipes/recipes/survey_timing/builder/`;
  zip.file("OriginID.txt", origin);

  zip.generateAsync({ type: "blob" }).then(blob => {
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${formName}.zip`;
    link.click();
    URL.revokeObjectURL(link.href);
  });
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function handleXmlImport(file) {
  if (!file) return;

  file.text().then(text => {
    const project = parseRedcapXml(text);
    state.parsedProject = project;
    state.surveys = project.surveys;

    renderProjectInfo();
    renderSurveySelection();
    renderDownloads();
  });
}

// ============================================================================
// INITIALIZATION
// ============================================================================

export function init() {
  // Form name input
  const formNameInput = document.getElementById("form-name");
  if (formNameInput) {
    formNameInput.value = state.formName;
    formNameInput.addEventListener("input", () => {
      state.formName = formNameInput.value.trim() || "survey_timing";
      renderDownloads();
    });
  }

  // XML file import
  const xmlInput = document.getElementById("xml-file");
  if (xmlInput) {
    xmlInput.addEventListener("change", (e) => {
      handleXmlImport(e.target.files[0]);
    });
  }

  // Initial render
  renderSurveySelection();
}
